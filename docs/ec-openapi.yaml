openapi: 3.0.0
info:
  title: E-commerce API
  version: "1.0.1"
  description: RESTful API для e-commerce платформы.

servers:
  - url: https://api.example.com/v1

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    UserRegister:
      type: object
      required:
        - username
        - email
        - password
      properties:
        username:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    UserLogin:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    AuthToken:
      type: object
      properties:
        token:
          type: string
        expires_in:
          type: integer

    UserProfile:
      type: object
      properties:
        user_id:
          type: string
        username:
          type: string
        email:
          type: string
          format: email
        created_at:
          type: string
          format: date-time

    Product:
      type: object
      properties:
        product_id:
          type: string
        code:
          type: string
        name:
          type: string
        brand:
          type: string
        description:
          type: string
        price:
          type: number
          format: float
        category:
          type: string
        images:
          type: array
          items:
            type: string
            format: uri

    ProductList:
      type: object
      properties:
        products:
          type: array
          items:
            $ref: '#/components/schemas/Product'
        pagination:
          type: object
          properties:
            current_page:
              type: integer
            total_pages:
              type: integer
            total_items:
              type: integer

    CartItem:
      type: object
      properties:
        item_id:
          type: string
        product_id:
          type: string
        name:
          type: string
        quantity:
          type: integer
        price:
          type: number
          format: float
        total_price:
          type: number
          format: float

    Cart:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        total_amount:
          type: number
          format: float

    Order:
      type: object
      properties:
        order_id:
          type: string
        status:
          type: string
        total_amount:
          type: number
          format: float
        created_at:
          type: string
          format: date-time

    OrderDetail:
      type: object
      properties:
        order_id:
          type: string
        status:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        delivery_address:
          $ref: '#/components/schemas/Address'
        shipping_method:
          type: string
        payment_method:
          type: string
        total_amount:
          type: number
          format: float
        created_at:
          type: string
          format: date-time

    Address:
      type: object
      properties:
        street:
          type: string
        city:
          type: string
        zip_code:
          type: string
        country:
          type: string

paths:
  /users/register:
    post:
      summary: Регистрация нового пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegister'
      responses:
        '200':
          description: Успешная регистрация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'

  /users/login:
    post:
      summary: Аутентификация пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserLogin'
      responses:
        '200':
          description: Успешная аутентификация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthToken'

  /users/profile:
    get:
      summary: Получение профиля пользователя
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Профиль пользователя
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
    put:
      summary: Обновление профиля пользователя
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Профиль обновлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'

  /products:
    get:
      summary: Получение списка товаров
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          description: Номер страницы
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
          description: Количество товаров на странице
        - in: query
          name: sort
          schema:
            type: string
          description: Критерий сортировки
        - in: query
          name: category
          schema:
            type: string
          description: Фильтр по категории
        - in: query
          name: price_min
          schema:
            type: number
          description: Минимальная цена
        - in: query
          name: price_max
          schema:
            type: number
          description: Максимальная цена
        - in: query
          name: brand
          schema:
            type: string
          description: Фильтр по бренду
      responses:
        '200':
          description: Список товаров
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductList'

  /products/search:
    get:
      summary: Поиск продуктов по составному фильтру
      description: Позволяет искать продукты по указанным полям. code, brand, name.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: query
          required: true
          schema:
            type: string
          description: Строка поиска
        - in: query
          name: fields
          required: true
          schema:
            type: array
            items:
              type: string
              enum:
                - code
                - brand
                - name
            example: [ "code", "name" ]
          style: form
          explode: false
          description: |
            Поля для поиска. Допустимые значения:
            - `code`: поиск по коду продукта
            - `brand`: поиск по бренду
            - `name`: поиск по названию продукта
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
          description: Количество продуктов на странице
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
          description: Смещение для пагинации
      responses:
        '200':
          description: Результаты поиска
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductList'
        '400':
          description: Некорректный запрос
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid parameters: 'query' and 'fields' are required."
        '401':
          description: Неавторизованный доступ
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Unauthorized"

  /products/{product_id}:
    get:
      summary: Получение информации о товаре
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: product_id
          required: true
          schema:
            type: string
          description: Идентификатор товара
      responses:
        '200':
          description: Информация о товаре
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
    delete:
      summary: Удаление товара
      description: Удаляет товар из каталога и отправляет сообщение в Kafka.
      security:
        - bearerAuth: [ ]
      parameters:
        - in: path
          name: product_id
          required: true
          schema:
            type: string
          description: Идентификатор удаляемого товара
      responses:
        '200':
          description: Товар успешно удален
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Product deleted successfully"
                  status:
                    type: string
                    example: "DELETED"
                  id:
                    type: string
                    example: "eab6723c-21e4-49f3-977b-80e75a685e99"
        '404':
          description: Товар не найден
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Product not found or already deleted"
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Failed to delete product"

  /cart/items:
    post:
      summary: Добавление товара в корзину
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - product_id
                - quantity
              properties:
                product_id:
                  type: string
                quantity:
                  type: integer
      responses:
        '200':
          description: Товар добавлен в корзину
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /cart/items/{item_id}:
    delete:
      summary: Удаление товара из корзины
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: item_id
          required: true
          schema:
            type: string
          description: Идентификатор товара в корзине
      responses:
        '200':
          description: Товар удален из корзины
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
    put:
      summary: Обновление количества товара в корзине
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: item_id
          required: true
          schema:
            type: string
          description: Идентификатор товара в корзине
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - quantity
              properties:
                quantity:
                  type: integer
      responses:
        '200':
          description: Количество товара обновлено
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /cart:
    get:
      summary: Просмотр содержимого корзины
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Содержимое корзины
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'

  /orders:
    post:
      summary: Создание заказа
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - payment_method
                - delivery_address
                - shipping_method
              properties:
                payment_method:
                  type: string
                delivery_address:
                  $ref: '#/components/schemas/Address'
                shipping_method:
                  type: string
      responses:
        '200':
          description: Заказ создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'

    get:
      summary: Получение списка заказов пользователя
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Список заказов
          content:
            application/json:
              schema:
                type: object
                properties:
                  orders:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'

  /orders/{order_id}:
    get:
      summary: Получение информации о заказе
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
          description: Идентификатор заказа
      responses:
        '200':
          description: Детализация заказа
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetail'

security:
  - bearerAuth: []
